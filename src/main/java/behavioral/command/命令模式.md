# 命令模式

**命令模式 Command Pattern**: 将一个请求封装为一个对象，从而可用不同的请求对客户端进行参数化，对请求排队或者记录请求日志，以及支持可撤销的操作。

命令模式是常用的行为型设计模式之一，是一种对象行为型模式，别名为 动作（Action）模式或事务（Transaction）模式。
在命令模式中，发送者与接受者解耦，之间引入新的命令对象，将发送者的请求封装在命令对象中，再通过命令对象来调用接收者的方法。

本质是对请求封装，一个请求对应于一个命令，将发出命令的职责与执行命令的责任分割开。
命令模式允许请求的一方和接收的一方独立开来，使得请求的一方不必知道接收请求的一方的接口，更不必知道请求如何被接收、操作是否被执行，何时被执行，如何被执行。

命令模式中，每一个具体命令对应一个请求的处理者，通过向请求发送者注入不同的具体命令对象可以使相同的发送者对应不同的接收者。
从而实现“将一个请求封装为一个对象，用不同的请求对客户进行参数化”。

命令模式的重点不在于封装状态，而是封装行为、解耦对象、行为对象化。

## 结构

- Command 抽象命令类：一个抽象类或接口，声明了用于执行请求的 execute 等方法，用于调用请求接收者的相关操作
- ConcreteCommand 具体命令类：抽象命令类的子类
- Invoker 调用者：即请求发送者，通过命令对象来执行请求。并不需要在设计时确定其接收者，运行时可以将一个具体命令对象注入其中。
- Receiver 接收者：执行与请求相关的操作，具体实现对请求的业务处理

# 优缺点/适用环境

## 优点

- 降低系统耦合度，请求发送者和接收者之间完全解耦。
- 新的命令可以很容易地加入到系统中，满足开闭原则
- 可以比较容易地设计一个命令队列或宏命令（组合命令）
- 为请求的撤销和恢复提供了一种设计和实现方案

## 缺点

可能导致系统有过多的具体命令类

## 适用环境

- 系统需要将请求调用者与接收者解耦
- 系统需要在不同时间指定请求，将请求排队和执行请求
- 系统需要支持命令的撤销和恢复
- 系统需要将一组操作组合在一起形成宏命令

# 本例

为了用户使用方便， 系统提供了一系列功能键，用户可以自定义功能键的功能。
例如功能键 F 可以用于退出系统、显示帮助文档等。

用户可以通过修改配置文件改变功能键的用途，现使用命令模式设计该系统。

## 分析

- FunctionButton 充当请求调用者
- SystemExitFunc、DisplayHelpFunc 充当请求接收者
- AbstractCommand、ExitCommand、HelpCommand 分别充当抽象命令类与具体命令类

如果系统中增加了新的功能，仅需对应增加一个新的具体命令类，然后将对象通过配置文件注入到功能键即可。符合开闭原则。

# 命令队列

有时候，当一个请求发送者发送一个请求时不止有一个请求接收者产生响应，这些请求接收者将逐个执行业务方法。此时可以通过命令队列来实现。

最常用、最灵活的一种方式是增加一个 CommandQueue 类，负责存储多个命令对象。不同的命令对象对应不同的请求接收者。
请求发送者针对 CommandQueue 进行编程。

命令队列和批处理有点类似，如果请求接收者的接受次序没有严格的先后次序，可以使用多线程技术并发调用命令对象的 execute 方法。

示例见 `queue` 包。

# 记录请求日志

将请求的历史记录保存，请求日志文件可以实现很多功能：

- 为系统提供恢复机制，记录用户对系统的每一步操作，让系统能够顺利恢复到某一个特定的状态
- 存储一系列命令对象，实现批处理
- 可以将命令队列中的所有命令对象都存储在一个日志文件中，每执行一个命令则删除一个对象，防止因意外导致的请求丢失。
  也可以避免重复发送全部请求时造成某些命令的重复执行。

在实现请求日志时，可以将发送请求的命令对象通过序列化写入到日志文件中，此时命令类必须实现 `java.io.Serializable` 接口。

# 实现撤销操作

命令模式中可以通过对命令类进行修改使得系统支持撤销（Undo）和恢复（Redo）操作。

## 示例

设计一个简易加法器，可以实现简单的加法运算，并对运算进行撤销操作。

见 `adder` 包下。

### 分析

- 加法类 Adder 充当请求接收者
- AbstractCommand 类充当抽象命令类，AddCommand 充当具体命令类。
- CalculateForm 充当请求发送者，通过命令对象间接调用请求接收者的业务处理方法

本例中只能实现一次撤销操作，因为没有保存命令对象的历史状态。
可以通过引入一个命令集合或者通过其他方式存储每一次操作时命令的状态，实现多次撤销操作。
还可以通过类似的方式实现恢复操作。

# 宏命令

宏命令（Macro Command）又称为组合命令（Composite Command），是组合模式和命令模式联用的产物。
宏命令是一个具体命令类，拥有一个集合，集合中包含了对其他命令对象的引用。

通常宏命令不直接与请求接收者交互，而是通过它的成员来调用接收者的方法。

调用宏命令的 execute 方法时将递归调用它所包含的每个成员命令的 execute 方法。一个宏命令的成员可以是简单命令，也可以是宏命令。
