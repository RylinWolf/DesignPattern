# 组合型设计模式

**组合模式 Composite Pattern**：组合多个对象形成树型结构以表示具有部分-整体关系的层次结构。
组合模式让客户端可以统一对待单个对象和组合对象。

又称为“部分-整体 Part-Whole”模式。属于对象结构型模式。将对象组织到树型结构中，可以用来描述部分与整体的关系。

关键在于定义了一个抽象构件类，既可以表示叶子，也可代表容器。客户端类针对该类编程，无需考虑该实例是叶子还是容器。
同时容器对象与抽象构件类之间还建立一个聚合关联关系，在容器对象中既可以包含叶子，也可包含容器，以此实现递归组合，形成树状结构。

# 结构

- **Component 抽象构件**：可以是接口或抽象类，为叶子构件和容器构建对象声明接口。该角色中可以包含所有子类共有行为的声明和实现。
  其中定义了管理它的子构件的方法。
- **Leaf 叶子构件**：表示叶子结点对象，没有子节点。对于访问及管理子构件的方法可以抛出异常或提示错误等方式。实现了抽象构件中定义的行为。
- **Composite 容器构件**：表示容器结点对象，包含子结点（叶子结点或容器结点），提供集合用于存储子结点。
  业务方法可以递归调用子结点的业务方法。实现了抽象构件中定义的行为。

# 透明组合模式与安全组合模式

根据抽象构件类的定义，可分为透明/安全组合模式。

## 透明组合模式

在透明组合模式中，抽象构件 Component 中声明了所有用于管理成员对象的方法，包括 add、remove、getChild 等。
这样做的好处是确保所有的构件类都有相同的接口。客户端可以一致对待所有的对象。

缺点是不够安全，因为叶子对象不可能有下一个层次的对象，所以管理对象的方法是没有意义的，调用可能会出错。

## 安全组合模式

在安全组合模式中，抽象构件 Component 没有声明任何用于管理成员的方法，而是在容器构件 Composite 中声明并实现。
这种做法是安全的，对于叶子对象，客户端不可能调用到这些方法。

缺点是不够透明，客户端必须有区别地对待叶子构件和容器构件。

# 优缺点/适用环境

## 优点

- 可以清楚地定义分层次的复杂对象。让客户端忽略了层次的差异，方便对整个层次结构进行控制
- 客户端可以一致地使用一个组合结构或其中单个对象
- 增加新的容器构件和叶子构件都很方便
- 为树型结构的面向对象实现提供了一种灵活的解决方案，通过叶子对象和容器对象的递归组合可以形成复杂的树型结构

## 缺点

增加新构件时，很难对容器中的构件类型进行限制。不能依赖类型系统施加类型约束，因为都来自相同的抽象层，必须通过运行时进行类型检查来实现。

## 适用环境

- 在具有整体和部分的层次结构中希望通过一种方式忽略整体与部分的差异，客户端可以一致地对待它们。
- 在使用面向对象语言开发的系统中需要处理一个属性结构
- 一个系统中能够分离出叶子对象和容器对象，且类型不固定，需要增加一些新的类型

# 本例

开发一个杀毒（Antivirus）软件，既可以对某个文件夹杀毒，又可以对某个指定的文件杀毒。
还可以根据各类文件的特点为不同类型的文件提供不同杀毒方式，例如图像文件和文本文件的杀毒方式就有所差异。
使用组合模式来设计该杀毒软件的整体框架。

## 分析

- AbstractFile 充当抽象构件类，Folder 充当容器构件类，ImageFile、TextFile、VideoFile 充当叶子构件类
- 创建对应类，容器/叶子构件类均继承抽象构件类，实现方法
- 容器构件类实现全部业务方法
- 叶子构件类对于修改、访问子构件的业务方法进行错误提示或抛出异常
- 创建客户端，构造树型结构，调用顶级容器的业务方法进行测试
